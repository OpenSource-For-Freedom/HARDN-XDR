#!/bin/bash
set -ex

LOG_FILE="/tmp/postinst.log"

{
  echo "[postinst] Executed on $(date)"
  echo "[postinst] Performing manual setup..."

  # Symlink launcher
  if [ -f /usr/lib/hardn-xdr/src/setup/hardn-main.sh ]; then
    ln -sf /usr/lib/hardn-xdr/src/setup/hardn-main.sh /usr/bin/hardn-xdr
    chmod +x /usr/bin/hardn-xdr
    chmod +x /usr/lib/hardn-xdr/src/setup/hardn-main.sh
    echo "[postinst] Installed /usr/bin/hardn-xdr â†’ hardn-main.sh"
  else
    echo "[postinst] ERROR: hardn-main.sh not found under /usr/lib/hardn-xdr/src/setup"
  fi


  if [ -f /usr/lib/hardn-xdr/src/setup/hardn-common.sh ]; then
    chmod +x /usr/lib/hardn-xdr/src/setup/hardn-common.sh
    echo "[postinst] Verified hardn-common.sh is present and executable."
  else
    echo "[postinst] ERROR: hardn-common.sh not found. Modules will fail without it."
  fi


  if [ -d /usr/lib/hardn-xdr/src/setup/modules ]; then
    find /usr/lib/hardn-xdr/src/setup/modules -type f -name "*.sh" -exec chmod +x {} \;
    echo "[postinst] Module permissions set."
  else
    echo "[postinst] WARNING: Modules directory not found."
  fi


  mkdir -p /var/log/debsums
  mkdir -p /usr/local/var/log/suricata
  echo "[postinst] Created log directories for HARDN modules."

  echo "[postinst] HARDN-XDR installed successfully."
  echo "Run with: sudo hardn-xdr"
} | tee "$LOG_FILE"

exit 0