#!/bin/sh

LOG_FILE="/tmp/postinst.log"

echo "[postinst] Executed on $(date)" > "$LOG_FILE"
echo "[postinst] Performing manual setup..." >> "$LOG_FILE"

# Symlink launcher
if [ -f /usr/lib/hardn-xdr/src/setup/hardn-main.sh ]; then
  ln -sf /usr/lib/hardn-xdr/src/setup/hardn-main.sh /usr/bin/hardn-xdr
  chmod +x /usr/bin/hardn-xdr
  chmod +x /usr/lib/hardn-xdr/src/setup/hardn-main.sh
  echo "[postinst] Installed /usr/bin/hardn-xdr â†’ hardn-main.sh" >> "$LOG_FILE"
else
  echo "[postinst] ERROR: hardn-main.sh not found." >> "$LOG_FILE"
fi

# Common file
if [ -f /usr/lib/hardn-xdr/src/setup/hardn-common.sh ]; then
  chmod +x /usr/lib/hardn-xdr/src/setup/hardn-common.sh
  echo "[postinst] Verified hardn-common.sh is executable." >> "$LOG_FILE"
else
  echo "[postinst] ERROR: hardn-common.sh not found." >> "$LOG_FILE"
fi

# Modules
if [ -d /usr/lib/hardn-xdr/src/setup/modules ]; then
  find /usr/lib/hardn-xdr/src/setup/modules -type f -name "*.sh" -exec chmod +x {} \;
  echo "[postinst] Module permissions set." >> "$LOG_FILE"
else
  echo "[postinst] WARNING: Modules directory not found." >> "$LOG_FILE"
fi

# Log dirs
mkdir -p /var/log/debsums
mkdir -p /usr/local/var/log/suricata
echo "[postinst] Created log directories." >> "$LOG_FILE"

echo "[postinst] HARDN-XDR installed successfully. Run it with: sudo hardn-xdr" >> "$LOG_FILE"

exit 0