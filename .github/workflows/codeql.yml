name: "Security Overwatch"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '23 15 * * 2'

jobs:
  security-checks:
    name: Run ShellCheck Security Scans
    runs-on: ubuntu-latest
    container:
      image: debian:latest # Use a Debian container
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install ShellCheck
      run: |
        echo "Installing ShellCheck..."
        apt update && apt install -y shellcheck

    - name: Run ShellCheck on Shell Scripts
      run: |
        echo "Running ShellCheck..."
        mkdir -p scan_results
        for script in $(find . -type f -name "*.sh"); do
          echo "Scanning $script"
          sanitized_name=$(echo "$script" | sed 's/\//_/g')
          shellcheck "$script" > "scan_results/$sanitized_name.txt" || true
        done
        echo "ShellCheck completed. Results stored in scan_results/"

    - name: Install Git
      run: |
        echo "Installing Git..."
        apt update && apt install -y git

    - name: Configure Safe Directory
      run: |
        echo "Configuring Git safe directory..."
        git config --global --add safe.directory /__w/HARDN-XDR/HARDN-XDR

    - name: Initialize Git Repository
      run: |
        echo "Initializing Git repository..."
        git init
        git remote add origin $GITHUB_SERVER_URL/$GITHUB_REPOSITORY
        git fetch origin
        git checkout -b shellcheck-fixes || git checkout shellcheck-fixes

    - name: Commit and Push Fixes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Committing fixes..."
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git add scan_results/
        git commit -m "Apply Security fixes"
        echo "Pulling latest changes from remote branch..."
        git pull --rebase origin shellcheck-fixes || true
        echo "Pushing changes to remote branch..."
        git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} shellcheck-fixes --force

    - name: Install GitHub CLI
      run: |
        echo "Installing GitHub CLI..."
        apt update && apt install -y gh
        echo "Verifying GitHub CLI installation..."
        gh --version

    - name: Create Pull Request
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Creating pull request..."
        gh pr create --title "ShellCheck Fixes" --body "This pull request contains fixes for issues identified during the ShellCheck scan." --base main --head shellcheck-fixes

    - name: Create or Update Weekly Issue
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Checking for existing issue..."
        ISSUE_TITLE="Weekly ShellCheck Findings"
        ISSUE_BODY="This issue contains the results of the weekly ShellCheck scans."
        EXISTING_ISSUE=$(gh issue list --search "$ISSUE_TITLE" --json number | jq -r '.[0].number')

        if [ "$EXISTING_ISSUE" != "null" ]; then
          echo "Updating existing issue..."
          RESULTS=$(cat scan_results/*.txt)
          gh issue comment "$EXISTING_ISSUE" --body "Updated results:\n\`\`\`\n$RESULTS\n\`\`\`"
        else
          echo "Creating new issue..."
          RESULTS=$(cat scan_results/*.txt)
          gh issue create --title "$ISSUE_TITLE" --body "$ISSUE_BODY\n\`\`\`\n$RESULTS\n\`\`\`"