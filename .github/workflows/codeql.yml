name: "Security Shell Overwatch"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '23 15 * * 2'

jobs:
  security-checks:
    name: Run ShellCheck Security Scans
    runs-on: ubuntu-latest
    container:
      image: ubuntu:latest # Use an Ubuntu container
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install ShellCheck
      run: |
        echo "Installing ShellCheck..."
        apt update && apt install -y shellcheck

    - name: Run ShellCheck on Shell Scripts
      run: |
        echo "Running ShellCheck..."
        mkdir -p scan_results
        for script in $(find . -type f -name "*.sh"); do
          echo "Scanning $script"
          sanitized_name=$(echo "$script" | sed 's/\//_/g')
          shellcheck "$script" > "scan_results/$sanitized_name.txt" || true
        done
        echo "ShellCheck completed. Results stored in scan_results/"

    - name: Install Git
      run: |
        echo "Installing Git..."
        apt update && apt install -y git

    - name: Configure Safe Directory
      run: |
        echo "Configuring Git safe directory..."
        git config --global --add safe.directory /__w/HARDN-XDR/HARDN-XDR

    - name: Initialize Git Repository and Reuse or Create Branch
      run: |
        echo "Initializing Git repository..."
        git init
        git remote add origin $GITHUB_SERVER_URL/$GITHUB_REPOSITORY
        echo "Fetching remote history..."
        git fetch origin
        echo "Cleaning up untracked files..."
        git clean -fdx || true
        echo "Checking out the main branch..."
        git checkout -t origin/main
        BRANCH_NAME="shellcheck-fixes"
        echo "Checking if branch $BRANCH_NAME exists..."
        if git show-ref --quiet refs/heads/$BRANCH_NAME; then
          echo "Branch $BRANCH_NAME exists. Switching to it..."
          git checkout $BRANCH_NAME
        else
          echo "Branch $BRANCH_NAME does not exist. Creating it..."
          git checkout -b $BRANCH_NAME
        fi

    - name: Commit and Push Fixes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Committing fixes..."
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        BRANCH_NAME="shellcheck-fixes"
        if [ -d "scan_results" ] && [ "$(ls -A scan_results)" ]; then
          git add scan_results/
          git commit -m "Update Security fixes"
        else
          echo "No files to commit in scan_results/ directory. Creating a dummy commit to ensure branch has history."
          echo "Dummy commit content" > dummy_file.txt
          git add dummy_file.txt
          git commit -m "Dummy commit to ensure branch has history"
        fi
        echo "Pushing branch: $BRANCH_NAME"
        git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} $BRANCH_NAME || true

    - name: Install GitHub CLI
      run: |
        echo "Installing GitHub CLI..."
        apt update && apt install -y gh
        echo "Verifying GitHub CLI installation..."
        gh --version

    - name: Create or Update Pull Request
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        BRANCH_NAME="shellcheck-fixes"
        echo "Checking for existing pull request for branch: $BRANCH_NAME..."
        EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" | grep -o '#[0-9]*' | head -n 1)
        if [ -n "$EXISTING_PR" ]; then
          echo "Updating existing pull request..."
          RESULTS=$(cat scan_results/*.txt)
          gh pr comment "$EXISTING_PR" --body "Updated results:\n\`\`\`\n$RESULTS\n\`\`\`"
        else
          echo "Creating new pull request..."
          gh pr create --title "ShellCheck Fixes" --body "This pull request contains fixes for issues identified during the ShellCheck scan." --base main --head "$BRANCH_NAME"
        fi