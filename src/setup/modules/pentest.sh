HARDN_STATUS "info" "Running comprehensive security audit with Lynis and nmap..."

improve_lynis_score() {
        HARDN_STATUS "info" "Implementing recommended Lynis hardening measures..."

        chmod 600 /etc/crontab /etc/cron.* 2>/dev/null || true
        chmod 700 /etc/cron.d /etc/cron.daily /etc/cron.hourly /etc/cron.monthly /etc/cron.weekly 2>/dev/null || true

        # Add kernel audit parameter to GRUB if not present
        [ -f /etc/default/grub ] && ! grep -q "audit=1" /etc/default/grub && {
            sed -i 's/GRUB_CMDLINE_LINUX="/GRUB_CMDLINE_LINUX="audit=1 /' /etc/default/grub
            update-grub 2>/dev/null || true
            HARDN_STATUS "info" "Added kernel audit parameter to GRUB configuration"
        }

    # Improve kernel security
    [ -d /etc/sysctl.d ] && {
        cat > /etc/sysctl.d/99-lynis-hardening.conf <<EOF
# Kernel hardening settings recommended by Lynis
kernel.kptr_restrict = 2
kernel.dmesg_restrict = 1
kernel.perf_event_paranoid = 3
kernel.sysrq = 0
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1
EOF
        sysctl -p /etc/sysctl.d/99-lynis-hardening.conf 2>/dev/null || true
    }

        [ -f /etc/ssh/sshd_config ] && {
            sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config
            sed -i 's/#PermitEmptyPasswords no/PermitEmptyPasswords no/' /etc/ssh/sshd_config
            sed -i 's/#ClientAliveInterval 0/ClientAliveInterval 300/' /etc/ssh/sshd_config
            sed -i 's/#ClientAliveCountMax 3/ClientAliveCountMax 2/' /etc/ssh/sshd_config
            systemctl restart ssh 2>/dev/null || systemctl restart sshd 2>/dev/null || true
            HARDN_STATUS "info" "SSH configuration hardened"
        }

        # Enable process accounting
        if ! command -v accton >/dev/null 2>&1; then
            apt install -y acct >/dev/null 2>&1 && {
                touch /var/log/pacct
                accton /var/log/pacct
                HARDN_STATUS "info" "Process accounting enabled"
            }
        else
            touch /var/log/pacct
            accton /var/log/pacct
            HARDN_STATUS "info" "Process accounting enabled"
        fi

        HARDN_STATUS "pass" "Lynis hardening measures implemented"
}

setup_lynis() {
        if ! command -v lynis >/dev/null 2>&1; then
            HARDN_STATUS "info" "Installing Lynis..."
            apt install lynis -y >/dev/null 2>&1
        fi

        # Lynis log directory
        mkdir -p /var/log/lynis
        chmod 750 /var/log/lynis

        HARDN_STATUS "info" "Running Lynis system audits..."
        lynis audit system --verbose --log-file /var/log/lynis/hardn-audit.log --report-file /var/log/lynis/hardn-report.dat 2>/dev/null
        lynis audit system --pentest --verbose --log-file /var/log/lynis/hardn-pentest.log 2>/dev/null

        # Report summary generation
        [[ -f /var/log/lynis/hardn-report.dat ]] && {
            hardening_index=$(grep "hardening_index=" /var/log/lynis/hardn-report.dat 2>/dev/null | cut -d'=' -f2)
            [[ -n "$hardening_index" ]] && HARDN_STATUS "info" "Lynis Hardening Index: ${hardening_index}%"
            HARDN_STATUS "pass" "Lynis audit completed. Reports saved to /var/log/lynis/"
        } || {
            HARDN_STATUS "warning" "Lynis report file not found. Check /var/log/lynis/ for details."
        }
}

setup_nmap() {
        if ! command -v nmap >/dev/null 2>&1; then
            HARDN_STATUS "info" "Installing nmap..."
            apt install nmap -y >/dev/null 2>&1
        fi

        mkdir -p /var/log/nmap
        chmod 750 /var/log/nmap

        HARDN_STATUS "info" "Running network security scan on localhost..."
        nmap -sV -sC -oA /var/log/nmap/local-scan localhost 2>/dev/null || true
        HARDN_STATUS "pass" "Network security scan completed. Results saved to /var/log/nmap/local-scan.nmap"
}

run_security_scans() {
        improve_lynis_score
        setup_lynis
        setup_nmap
        HARDN_STATUS "info" "Security assessment complete. Review log files for recommendations."
}

# Call main
run_security_scans