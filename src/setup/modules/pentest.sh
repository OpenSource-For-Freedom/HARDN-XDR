HARDN_STATUS "info" "Running comprehensive security audit with Lynis and nmap..."

# Ensure Lynis is installed (it should be from progs.csv)
if ! command -v lynis >/dev/null 2>&1; then
	HARDN_STATUS "info" "Installing Lynis..."
	apt-get install lynis -y >/dev/null 2>&1
fi

# Create Lynis log directory
mkdir -p /var/log/lynis
chmod 750 /var/log/lynis

# Apply Lynis score improvements first
improve_lynis_score

# Run comprehensive Lynis audit
HARDN_STATUS "info" "Running comprehensive Lynis system audit..."
lynis audit system --verbose --log-file /var/log/lynis/hardn-audit.log --report-file /var/log/lynis/hardn-report.dat 2>/dev/null

# Run Lynis with pentest profile for additional checks
HARDN_STATUS "info" "Running Lynis penetration testing profile..."
lynis audit system --pentest --verbose --log-file /var/log/lynis/hardn-pentest.log 2>/dev/null

# Generate Lynis report
if [[ -f /var/log/lynis/hardn-report.dat ]]; then
	HARDN_STATUS "pass" "Lynis audit completed. Report saved to /var/log/lynis/hardn-report.dat"
	
	# Extract and display hardening index if available
	local hardening_index
	hardening_index=$(grep "hardening_index=" /var/log/lynis/hardn-report.dat 2>/dev/null | cut -d'=' -f2)
	if [[ -n "$hardening_index" ]]; then
		HARDN_STATUS "info" "Lynis Hardening Index: ${hardening_index}%"
	fi
else
	HARDN_STATUS "warning" "Lynis report file not found. Check /var/log/lynis/ for details."
fi

# Run nmap scan for network security assessment
HARDN_STATUS "info" "Starting network security assessment with nmap..."

# Install nmap if not present
if ! command -v nmap >/dev/null 2>&1; then
	apt install nmap -y >/dev/null 2>&1
fi

# Create nmap log directory
mkdir -p /var/log/nmap
chmod 750 /var/log/nmap

# Run comprehensive nmap scan
nmap -sS -sV -O -p- localhost > /var/log/nmap/hardn-localhost-scan.log 2>&1 &
local nmap_pid=$!

# Run network interface scan
local interface_ip
interface_ip=$(ip route get 1.1.1.1 2>/dev/null | grep -oP 'src \K\S+' | head -1)
if [[ -n "$interface_ip" ]]; then
	nmap -sn "${interface_ip%.*}.0/24" > /var/log/nmap/hardn-network-discovery.log 2>&1 &
fi

# Wait for localhost scan to complete
wait $nmap_pid
if wait $nmap_pid; then
	HARDN_STATUS "pass" "Network security scan completed. Results saved to /var/log/nmap/"
else
	HARDN_STATUS "error" "Network scan encountered issues. Check /var/log/nmap/ for details."
fi

# Summary of security audit
HARDN_STATUS "info" "Security audit summary:"
HARDN_STATUS "info" "- Lynis reports: /var/log/lynis/"
HARDN_STATUS "info" "- Network scans: /var/log/nmap/"
HARDN_STATUS "info" "- Review these files for security recommendations"
